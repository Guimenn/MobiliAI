// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema


generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}
        
enum UserRole {
  ADMIN           // Administrador da Matriz - Acesso total
  STORE_MANAGER   // Gerente de Loja - Acesso apenas à sua loja
  CASHIER         // Vendedor/Caixa - Acesso apenas ao PDV da sua loja
  CUSTOMER        // Cliente
}

enum ProductCategory {
  // Móveis Principais
  SOFA
  MESA
  CADEIRA
  ARMARIO
  ESTANTE
  POLTRONA
  
  
  // Decoração
  QUADRO
  LUMINARIA
  
  
  // Outros
  OUTROS
}

enum SaleStatus {
  PENDING
  COMPLETED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  PIX
  CREDIT_CARD
  DEBIT_CARD
  CASH
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum ProductStyle {
  MODERNO
  MINIMALISTA
  RUSTICO
}

enum MaterialType {
  MADEIRA
  METAL
  COURO
  TECIDO
}


model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  phone     String?
  address   String?
  city      String?
  state     String?
  zipCode   String?
  role      UserRole @default(CUSTOMER)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  storeId String?
  store   Store?  @relation(fields: [storeId], references: [id])
  
  purchases Sale[] @relation("CustomerSales")
  sales     Sale[] @relation("EmployeeSales")
  colorAnalyses ColorAnalysis[]
  furnitureAnalyses FurnitureAnalysis[]
  chatSessions ChatSession[]
  reviews ProductReview[]
  moodboards Moodboard[]
  dailyCash DailyCash[]
  cashExpenses CashExpense[]
  cashFlows CashFlow[]

  @@map("users")
}

model Store {
  id      String  @id @default(uuid())
  name    String
  address String
  city    String
  state   String
  zipCode String
  phone   String?
  email   String?
  isActive Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  employees User[]    @relation()
  products  Product[] @relation()
  sales     Sale[]    @relation()
  dailyCash DailyCash[]
  cashFlows CashFlow[]

  @@map("stores")
}

model Product {
  id          String          @id @default(uuid())
  name        String
  description String?
  shortDescription String?
  category    ProductCategory @default(SOFA)
  price       Decimal         @db.Decimal(10, 2)
  costPrice   Decimal?        @db.Decimal(10, 2)
  stock       Int             @default(0)
  minStock    Int             @default(0)
  
  // Atributos de Design
  style       ProductStyle?
  material    MaterialType?
  colorHex    String?         // Código hexadecimal da cor
  colorName   String?          // Nome da cor (ex: "Azul Marinho")
  customColor String?          // Cor personalizada descrita pelo cliente
  
  // Dimensões
  width       Decimal?         @db.Decimal(8, 2)  // Largura em cm
  height      Decimal?         @db.Decimal(8, 2)  // Altura em cm
  depth       Decimal?         @db.Decimal(8, 2)  // Profundidade em cm
  weight      Decimal?         @db.Decimal(8, 2)  // Peso em kg
  
  // Informações Comerciais
  brand       String?
  model       String?
  sku         String?          @unique
  barcode     String?          @unique
  
  // Mídia
  imageUrl    String?
  imageUrls   String[]          // Array de URLs de imagens
  videoUrl    String?
  
  // SEO e Marketing
  tags        String[]         // Tags para busca
  keywords    String[]         // Palavras-chave para SEO
  isFeatured  Boolean          @default(false)
  isNew       Boolean          @default(false)
  isBestSeller Boolean         @default(false)
  
  // Avaliações
  rating      Decimal?         @db.Decimal(3, 2)  // Rating de 0.00 a 5.00
  reviewCount Int              @default(0)
  
  // Status
  isActive    Boolean          @default(true)
  isAvailable Boolean          @default(true)
  
  // Timestamps
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relations
  storeId String
  store   Store      @relation(fields: [storeId], references: [id])
  saleItems SaleItem[]
  reviews ProductReview[]
  variants ProductVariant[]
  compatibility ProductCompatibility[]
  compatibleProducts ProductCompatibility[] @relation("CompatibleProducts")
  moodboardItems MoodboardItem[]
  collectionId String?
  collection Collection? @relation(fields: [collectionId], references: [id])
  supplierId String?
  supplier Supplier? @relation(fields: [supplierId], references: [id])

  @@map("products")
}

model Sale {
  id              String        @id @default(uuid())
  saleNumber      String        @unique
  totalAmount     Decimal       @db.Decimal(10, 2)
  discount        Decimal       @default(0) @db.Decimal(10, 2)
  tax             Decimal       @default(0) @db.Decimal(10, 2)
  status          SaleStatus    @default(PENDING)
  paymentMethod   PaymentMethod @default(CASH)
  paymentReference String?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  customerId String
  customer   User      @relation("CustomerSales", fields: [customerId], references: [id])
  
  employeeId String
  employee   User      @relation("EmployeeSales", fields: [employeeId], references: [id])
  
  storeId String
  store   Store     @relation(fields: [storeId], references: [id])
  
  dailyCashId String?
  dailyCash   DailyCash? @relation(fields: [dailyCashId], references: [id])
  
  items SaleItem[]

  @@map("sales")
}

model SaleItem {
  id        String  @id @default(uuid())
  quantity  Int
  unitPrice Decimal @db.Decimal(10, 2)
  totalPrice Decimal @db.Decimal(10, 2)
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  saleId String
  sale   Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  
  productId String
  product   Product @relation(fields: [productId], references: [id])

  @@map("sale_items")
}

model ColorAnalysis {
  id                String   @id @default(uuid())
  imageUrl          String
  detectedColors    Json
  suggestedColors   Json?
  recommendedProducts Json?
  processedImageUrl String?
  isProcessed       Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  @@map("color_analyses")
}

model FurnitureAnalysis {
  id                String   @id @default(uuid())
  imageUrl          String
  detectedSpaces    Json
  suggestedFurniture Json?
  recommendedProducts Json?
  processedImageUrl String?
  isProcessed       Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  @@map("furniture_analyses")
}

model ChatSession {
  id        String   @id @default(uuid())
  title     String
  isActive  Boolean  @default(true)
  context   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userId String
  user   User         @relation(fields: [userId], references: [id])
  messages ChatMessage[]

  @@map("chat_sessions")
}

model ChatMessage {
  id        String      @id @default(uuid())
  content   String
  role      MessageRole @default(USER)
  metadata  Json?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  // Relations
  sessionId String
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}

// Tabela de Avaliações de Produtos
model ProductReview {
  id        String   @id @default(uuid())
  rating    Int      // 1 a 5 estrelas
  title     String?
  comment   String?
  isVerified Boolean @default(false)
  helpful   Int      @default(0)  // Quantas pessoas acharam útil
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  userId String
  user   User   @relation(fields: [userId], references: [id])

  @@map("product_reviews")
}

// Tabela de Variantes de Produtos (cores, tamanhos, etc.)
model ProductVariant {
  id        String   @id @default(uuid())
  name      String   // Ex: "Azul Marinho", "Pequeno", "Grande"
  sku       String?  @unique
  price     Decimal? @db.Decimal(10, 2)  // Preço específico da variante
  stock     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_variants")
}

// Tabela de Compatibilidade entre Produtos
model ProductCompatibility {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  // Relations
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  compatibleProductId String
  compatibleProduct   Product @relation("CompatibleProducts", fields: [compatibleProductId], references: [id], onDelete: Cascade)

  @@unique([productId, compatibleProductId])
  @@map("product_compatibility")
}

// Tabela de Coleções/Tendências
model Collection {
  id          String   @id @default(uuid())
  name        String
  description String?
  imageUrl    String?
  isActive    Boolean  @default(true)
  isTrending  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  products Product[]

  @@map("collections")
}

// Tabela de Moodboards (salvos pelos usuários)
model Moodboard {
  id          String   @id @default(uuid())
  name        String
  description String?
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id])
  items  MoodboardItem[]

  @@map("moodboards")
}

// Itens de Moodboard
model MoodboardItem {
  id        String   @id @default(uuid())
  positionX Decimal @db.Decimal(8, 2)
  positionY Decimal @db.Decimal(8, 2)
  scale     Decimal  @db.Decimal(3, 2) @default(1.00)
  rotation  Decimal  @db.Decimal(5, 2) @default(0.00)
  createdAt DateTime @default(now())

  // Relations
  moodboardId String
  moodboard   Moodboard @relation(fields: [moodboardId], references: [id], onDelete: Cascade)
  
  productId String?
  product   Product? @relation(fields: [productId], references: [id])

  @@map("moodboard_items")
}

// Tabela de Fornecedores
model Supplier {
  id          String   @id @default(uuid())
  name        String
  cnpj        String?  @unique
  email       String?
  phone       String?
  address     String?
  city        String?
  state       String?
  zipCode     String?
  contactName String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  products Product[]

  @@map("suppliers")
}

// Tabela de Controle de Caixa Diário
model DailyCash {
  id              String   @id @default(uuid())
  date            DateTime @default(now())
  openingAmount  Decimal  @db.Decimal(10, 2)  // Valor de abertura
  closingAmount   Decimal? @db.Decimal(10, 2)  // Valor de fechamento
  totalSales      Decimal  @default(0) @db.Decimal(10, 2)
  totalExpenses   Decimal  @default(0) @db.Decimal(10, 2)
  isOpen          Boolean  @default(true)
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  storeId String
  store   Store   @relation(fields: [storeId], references: [id])
  
  userId String
  user   User     @relation(fields: [userId], references: [id])
  
  sales Sale[]
  expenses CashExpense[]

  @@map("daily_cash")
}

// Tabela de Despesas de Caixa
model CashExpense {
  id          String   @id @default(uuid())
  description String
  amount      Decimal  @db.Decimal(10, 2)
  category    String   // Ex: "Aluguel", "Luz", "Água", "Salários"
  date        DateTime @default(now())
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  dailyCashId String
  dailyCash   DailyCash @relation(fields: [dailyCashId], references: [id], onDelete: Cascade)
  
  userId String
  user   User     @relation(fields: [userId], references: [id])

  @@map("cash_expenses")
}

// Tabela de Fluxo de Caixa
model CashFlow {
  id          String   @id @default(uuid())
  type        String   // "INCOME" ou "EXPENSE"
  description String
  amount      Decimal  @db.Decimal(10, 2)
  category    String
  date        DateTime @default(now())
  isRecurring Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  storeId String
  store   Store   @relation(fields: [storeId], references: [id])
  
  userId String
  user   User     @relation(fields: [userId], references: [id])

  @@map("cash_flows")
}