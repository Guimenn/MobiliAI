'use client';

import { useEffect } from 'react';
import { useAppStore } from '@/lib/store';
import { customerAPI } from '@/lib/api';

export default function ClientProviders({ children }: { children: React.ReactNode }) {
  const { user, isAuthenticated, token, cart } = useAppStore();

  useEffect(() => {
    // Carregar carrinho do backend quando a pÃ¡gina inicia e o usuÃ¡rio estÃ¡ autenticado
    // Mas apenas para clientes (CUSTOMER role), nÃ£o para funcionÃ¡rios ou gerentes
    if (isAuthenticated && user && token && typeof window !== 'undefined') {
      // Verificar se o usuÃ¡rio Ã© um cliente
      const isCustomer = user.role === 'CUSTOMER' || user.role === 'customer';
      
      if (!isCustomer) {
        // Se nÃ£o Ã© cliente, nÃ£o tentar carregar carrinho
        return;
      }

      // Verificar se o carrinho jÃ¡ foi carregado (tem itens com IDs do backend)
      const hasBackendItems = cart.some(item => item.id);
      
      // SÃ³ carregar se:
      // 1. NÃ£o tem itens do backend E
      // 2. O carrinho estÃ¡ vazio (nÃ£o foi limpo intencionalmente)
      // 3. NÃ£o hÃ¡ flag de "jÃ¡ carregou" no sessionStorage
      const cartLoadedKey = `cart_loaded_${user.id}`;
      const alreadyLoaded = sessionStorage.getItem(cartLoadedKey);
      
      if (!hasBackendItems && cart.length === 0 && !alreadyLoaded) {
        (async () => {
          try {
            console.log('ðŸ”„ Carregando carrinho do backend na inicializaÃ§Ã£o...');
            const cartData = await customerAPI.getCart();
            
            // Marcar como carregado
            sessionStorage.setItem(cartLoadedKey, 'true');
            
            if (cartData?.items && cartData.items.length > 0) {
              // Obter carrinho atual para preservar dados locais dos produtos
              const currentCart = useAppStore.getState().cart;
              
              const cartItems = cartData.items.map((item: any) => {
                // Tentar encontrar produto correspondente no carrinho local para preservar dados
                const localItem = currentCart.find(ci => ci.product.id === item.product.id);
                const localProduct = localItem?.product;

                // Mesclar dados do backend com dados locais, preservando campos de oferta relÃ¢mpago
                return {
                  id: item.id,
                  product: {
                    id: item.product.id,
                    name: item.product.name,
                    description: item.product.description,
                    category: item.product.category?.toLowerCase() || 'sofa',
                    price: Number(item.product.price),
                    stock: item.product.stock || 0,
                    imageUrl: item.product.imageUrls?.[0] || item.product.imageUrl,
                    imageUrls: item.product.imageUrls || [],
                    colorName: item.product.colorName,
                    colorHex: item.product.colorHex,
                    brand: item.product.brand,
                    // Campos de Oferta Normal - usar dados do backend se disponÃ­veis, senÃ£o preservar do local
                    isOnSale: item.product.isOnSale !== undefined ? item.product.isOnSale : (localProduct?.isOnSale || false),
                    salePrice: item.product.salePrice ? Number(item.product.salePrice) : localProduct?.salePrice,
                    saleDiscountPercent: item.product.saleDiscountPercent ? Number(item.product.saleDiscountPercent) : localProduct?.saleDiscountPercent,
                    saleStartDate: item.product.saleStartDate || localProduct?.saleStartDate,
                    saleEndDate: item.product.saleEndDate || localProduct?.saleEndDate,
                    // Campos de Oferta RelÃ¢mpago - priorizar dados locais se existirem, senÃ£o usar do backend
                    isFlashSale: localProduct?.isFlashSale !== undefined ? localProduct.isFlashSale : (item.product.isFlashSale !== undefined ? item.product.isFlashSale : false),
                    flashSalePrice: localProduct?.flashSalePrice !== undefined ? localProduct.flashSalePrice : (item.product.flashSalePrice ? Number(item.product.flashSalePrice) : undefined),
                    flashSaleDiscountPercent: localProduct?.flashSaleDiscountPercent !== undefined ? localProduct.flashSaleDiscountPercent : (item.product.flashSaleDiscountPercent ? Number(item.product.flashSaleDiscountPercent) : undefined),
                    flashSaleStartDate: localProduct?.flashSaleStartDate || item.product.flashSaleStartDate || undefined,
                    flashSaleEndDate: localProduct?.flashSaleEndDate || item.product.flashSaleEndDate || undefined,
                    storeId: item.product.storeId || item.product.store?.id || '',
                    storeName: item.product.store?.name,
                    storeAddress: item.product.store?.address,
                    store: item.product.store ? {
                      id: item.product.store.id,
                      name: item.product.store.name,
                      address: item.product.store.address,
                      zipCode: item.product.store.zipCode,
                      city: item.product.store.city,
                      state: item.product.store.state,
                    } : undefined,
                    storeInventory: item.product.storeInventory ? item.product.storeInventory.map((inv: any) => ({
                      storeId: inv.storeId,
                      quantity: inv.quantity,
                      store: inv.store ? {
                        id: inv.store.id,
                        name: inv.store.name,
                        address: inv.store.address,
                        zipCode: inv.store.zipCode,
                        city: inv.store.city,
                        state: inv.store.state,
                        isActive: inv.store.isActive,
                      } : undefined,
                    })) : undefined,
                  },
                  quantity: item.quantity,
                };
              });
              
              const cartTotal = cartItems.reduce(
                (total: number, item: any) => total + (Number(item.product.price) * item.quantity),
                0
              );
              
              useAppStore.setState({ cart: cartItems, cartTotal });
              console.log('âœ… Carrinho carregado na inicializaÃ§Ã£o:', cartItems.length, 'itens');
            } else {
              // Se o carrinho estÃ¡ vazio no backend, garantir que estÃ¡ limpo localmente
              useAppStore.setState({ cart: [], cartTotal: 0 });
              console.log('âœ… Carrinho vazio no backend');
            }
          } catch (error: any) {
            console.error('âŒ Erro ao carregar carrinho na inicializaÃ§Ã£o:', {
              error: error.message,
              response: error.response?.data,
              status: error.response?.status
            });
          }
        })();
      }
    } else if (!isAuthenticated) {
      // Se nÃ£o estÃ¡ autenticado, limpar flags
      if (typeof window !== 'undefined') {
        Object.keys(sessionStorage).forEach(key => {
          if (key.startsWith('cart_loaded_')) {
            sessionStorage.removeItem(key);
          }
        });
      }
    }
  }, [isAuthenticated, user, token]); // Executar quando auth mudar

  return <>{children}</>;
}

