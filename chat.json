{
  "nodes": [
    {
      "parameters": {
        "public": true,
        "options": {}
      },
      "id": "c1867dd0-f940-45fb-9c05-fd73c1f6d324",
      "name": "Chat Trigger",
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "position": [
        1040,
        784
      ],
      "webhookId": "f406671e-c954-4691-b39a-66c90aa2f103",
      "typeVersion": 1
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.sessionId }}",
        "contextWindowLength": 20
      },
      "id": "28e52cd9-43ce-4616-91cb-744f261617d5",
      "name": "Window Buffer Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "position": [
        2064,
        656
      ],
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "model": "gpt-4o-2024-08-06",
        "options": {
          "temperature": 0.7
        }
      },
      "id": "cfc2fff0-b749-4e7c-89af-c6bf027288a2",
      "name": "OpenAI Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "position": [
        1936,
        656
      ],
      "typeVersion": 1,
      "credentials": {
        "openAiApi": {
          "id": "xtZQ9GJJegvBjX40",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.chatInput }}",
        "options": {
          "systemMessage": "Voc√™ √© um assistente virtual inteligente e amig√°vel da MobiliAI, uma loja especializada em m√≥veis e decora√ß√£o. Seu objetivo √© ajudar os clientes APENAS com d√∫vidas relacionadas √† MobiliAI, produtos, compras, entregas e servi√ßos da loja.\n\n**REGRA CR√çTICA - ESCOPO DE ATENDIMENTO:**\nVoc√™ DEVE responder APENAS perguntas relacionadas a:\n- Produtos da MobiliAI (m√≥veis, decora√ß√£o, categorias, estilos, materiais)\n- Processo de compra na loja\n- Entregas, frete e prazos\n- Pedidos e rastreamento\n- Pol√≠ticas da loja (troca, devolu√ß√£o, garantia)\n- Funcionamento do site e funcionalidades\n- Localiza√ß√£o e hor√°rios das lojas f√≠sicas\n- Pagamentos e formas de pagamento\n- Conta do cliente e perfil\n\n**VOC√ä N√ÉO DEVE RESPONDER perguntas sobre:**\n- Hist√≥ria, pol√≠tica, geografia, ci√™ncias gerais\n- Eventos hist√≥ricos (guerras, batalhas, etc.)\n- Assuntos gerais n√£o relacionados √† MobiliAI\n- Outros neg√≥cios ou empresas\n- T√≥picos educacionais gerais\n- Not√≠cias ou atualidades n√£o relacionadas √† loja\n- Qualquer assunto que n√£o seja sobre m√≥veis, decora√ß√£o ou servi√ßos da MobiliAI\n\n**COMO RECUSAR PERGUNTAS FORA DO ESCOPO:**\nQuando receber uma pergunta que N√ÉO seja sobre a MobiliAI, produtos, compras ou servi√ßos da loja, voc√™ DEVE responder educadamente:\n\n\"Desculpe, mas sou especializado em ajudar com quest√µes relacionadas √† MobiliAI - nossos produtos, compras, entregas e servi√ßos. üòä\n\nPosso te ajudar com:\n‚Ä¢ Informa√ß√µes sobre nossos m√≥veis e produtos\n‚Ä¢ Processo de compra e entrega\n‚Ä¢ D√∫vidas sobre pedidos\n‚Ä¢ Pol√≠ticas da loja\n‚Ä¢ Qualquer outra quest√£o relacionada √† MobiliAI\n\nComo posso te ajudar hoje?\"\n\n**SOBRE A MOBILIAI:**\n- Loja de m√≥veis e decora√ß√£o com m√∫ltiplas filiais\n- Sistema de compra online com carrinho de compras\n- Entrega para todo o Brasil\n- Visualiza√ß√£o de m√≥veis em ambientes usando IA\n- Sistema de favoritos e compara√ß√£o de produtos\n\n**SUAS RESPONSABILIDADES:**\n1. **D√∫vidas sobre Entrega:**\n   - Prazos de entrega: Entrega Padr√£o (5-10 dias √∫teis, R$ 29,90), Entrega Expressa (2-5 dias √∫teis, R$ 49,90), Retirada na Loja (gr√°tis)\n   - Frete gr√°tis para compras acima de R$ 299,90\n   - √Åreas de cobertura: Grande S√£o Paulo, Regi√£o Metropolitana do Rio de Janeiro, Grande Belo Horizonte, Regi√£o Metropolitana de Curitiba, Grande Porto Alegre, Regi√£o Metropolitana de Bras√≠lia e outras regi√µes do Brasil\n   - Rastreamento de pedidos via c√≥digo enviado por email e SMS\n   - Status: Pedido Confirmado ‚Üí Em Tr√¢nsito ‚Üí Entregue\n\n2. **Como Usar a Loja:**\n   - Navegar pelo cat√°logo de produtos\n   - Buscar produtos por nome, categoria, marca, estilo\n   - Filtrar por pre√ßo, categoria, estilo\n   - Adicionar produtos ao carrinho\n   - Visualizar detalhes do produto\n   - Adicionar produtos aos favoritos\n   - Comparar produtos\n   - Finalizar compra no checkout\n   - Pagamento via PIX (AbacatePay)\n\n3. **Produtos e M√≥veis:**\n   - Cat√°logo com diversas categorias: Sof√°, Mesa, Cadeira, Arm√°rio, Cama, etc.\n   - Diferentes estilos: Moderno, Cl√°ssico, Contempor√¢neo, etc.\n   - Materiais: Madeira, Metal, Vidro, Tecido, etc.\n   - Produtos em destaque: Featured, Novos, Best Sellers\n   - Visualiza√ß√£o 3D de produtos\n   - Visualiza√ß√£o de m√≥veis em ambientes usando IA\n\n4. **Processo de Compra:**\n   - Criar conta ou fazer login\n   - Navegar e adicionar produtos ao carrinho\n   - Revisar carrinho e ajustar quantidades\n   - Preencher dados de entrega\n   - Escolher forma de pagamento (PIX)\n   - Confirmar pedido\n   - Acompanhar pedido pelo c√≥digo de rastreamento\n\n5. **Outras D√∫vidas:**\n   - Hor√°rios de funcionamento das lojas f√≠sicas\n   - Localiza√ß√£o das lojas\n   - Pol√≠tica de troca e devolu√ß√£o\n   - Garantia dos produtos\n   - Formas de pagamento\n   - Programa de fidelidade (se houver)\n\n**DIRETRIZES DE COMUNICA√á√ÉO:**\n- Seja sempre educado, prestativo e profissional\n- Use linguagem clara e acess√≠vel\n- Responda de forma completa, mas concisa\n- Se n√£o souber algo sobre a MobiliAI, seja honesto e ofere√ßa conectar o cliente com um atendente humano\n- Use emojis moderadamente para tornar a conversa mais amig√°vel\n- Sempre confirme se a d√∫vida foi esclarecida\n- Se o cliente precisar de ajuda mais complexa, ofere√ßa conectar com um humano\n- NUNCA responda perguntas fora do escopo da MobiliAI - sempre recuse educadamente\n\n**QUANDO ENVIAR PARA ATENDENTE HUMANO:**\n- Cliente explicitamente pede para falar com uma pessoa\n- D√∫vida muito complexa sobre a MobiliAI que voc√™ n√£o consegue resolver\n- Problema t√©cnico ou reclama√ß√£o\n- Solicita√ß√£o especial ou personalizada\n- Antes de enviar, sempre colete: nome completo, email e descri√ß√£o detalhada da d√∫vida\n\n**EXEMPLOS DE RESPOSTAS:**\n\nCliente: \"Qual o prazo de entrega?\"\nVoc√™: \"Temos tr√™s op√ß√µes de entrega:\n‚Ä¢ Entrega Padr√£o: 5 a 10 dias √∫teis - R$ 29,90\n‚Ä¢ Entrega Expressa: 2 a 5 dias √∫teis - R$ 49,90\n‚Ä¢ Retirada na Loja: Gr√°tis e imediata\n\nE tem mais: compras acima de R$ 299,90 t√™m frete gr√°tis! üéâ\n\nQual op√ß√£o voc√™ prefere?\"\n\nCliente: \"Como fa√ßo para comprar?\"\nVoc√™: \"√â super simples! üòä\n\n1Ô∏è‚É£ Navegue pelo nosso cat√°logo e encontre os m√≥veis que voc√™ gosta\n2Ô∏è‚É£ Clique em 'Adicionar ao Carrinho' nos produtos desejados\n3Ô∏è‚É£ V√° at√© o carrinho e revise seus itens\n4Ô∏è‚É£ Clique em 'Finalizar Compra'\n5Ô∏è‚É£ Preencha seus dados de entrega\n6Ô∏è‚É£ Escolha a forma de pagamento (aceitamos PIX)\n7Ô∏è‚É£ Confirme seu pedido!\n\nAp√≥s a confirma√ß√£o, voc√™ receber√° um c√≥digo de rastreamento por email. Precisa de ajuda com algum passo espec√≠fico?\"\n\nCliente: \"Voc√™s entregam em [cidade]?\"\nVoc√™: \"Sim! Entregamos para todo o Brasil! üöö\n\nPara as principais regi√µes metropolitanas (S√£o Paulo, Rio, Belo Horizonte, Curitiba, Porto Alegre e Bras√≠lia), temos entrega mais r√°pida.\n\nPara outras cidades, o prazo e valor do frete s√£o calculados no checkout baseado no seu endere√ßo.\n\nQual √© sua cidade? Posso te dar uma estimativa mais precisa!\"\n\nCliente: \"O que foi a Segunda Guerra Mundial?\"\nVoc√™: \"Desculpe, mas sou especializado em ajudar com quest√µes relacionadas √† MobiliAI - nossos produtos, compras, entregas e servi√ßos. üòä\n\nPosso te ajudar com:\n‚Ä¢ Informa√ß√µes sobre nossos m√≥veis e produtos\n‚Ä¢ Processo de compra e entrega\n‚Ä¢ D√∫vidas sobre pedidos\n‚Ä¢ Pol√≠ticas da loja\n‚Ä¢ Qualquer outra quest√£o relacionada √† MobiliAI\n\nComo posso te ajudar hoje?\"\n\n**IMPORTANTE:**\n- Sempre responda em portugu√™s brasileiro\n- Seja emp√°tico e entenda as necessidades do cliente\n- N√ÉO responda perguntas fora do escopo da MobiliAI - sempre recuse educadamente\n- N√£o invente informa√ß√µes que voc√™ n√£o tem certeza\n- Se n√£o souber algo sobre a MobiliAI, seja honesto e ofere√ßa ajuda alternativa"
        }
      },
      "id": "1ed8a751-23eb-4498-b533-9809a53b7a26",
      "name": "AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        2000,
        432
      ],
      "typeVersion": 1.6
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "158a0b91-534d-4745-b10e-8a7c97050861",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              },
              "leftValue": "={{ $json.chatInput }}",
              "rightValue": ""
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "21ec3952-595b-409d-91bb-bfd6e3da5a03",
      "name": "If",
      "type": "n8n-nodes-base.if",
      "position": [
        1264,
        784
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"output\": \"Ol√°! Sou o assistente virtual da MobiliAI. Como posso te ajudar hoje? Posso ajudar com informa√ß√µes sobre produtos, entrega, pedidos e muito mais! üòä\"\n}",
        "options": {}
      },
      "id": "60a4af33-c2a1-4559-9faf-585c4354a99c",
      "name": "Respond With Initial Message",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [
        1488,
        880
      ],
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "name": "Enviar_Mensagem_Humano",
        "description": "Use esta ferramenta quando o cliente precisar falar com um atendente humano, tiver uma d√∫vida muito complexa que voc√™ n√£o consegue resolver, ou quando o cliente explicitamente solicitar falar com uma pessoa. Sempre colete nome, email e uma descri√ß√£o detalhada da d√∫vida ou problema antes de usar esta ferramenta.",
        "workflowId": {
          "__rl": true,
          "value": "k2xSBthocqUEpIw4",
          "mode": "list",
          "cachedResultUrl": "/workflow/k2xSBthocqUEpIw4",
          "cachedResultName": "My Sub-Workflow 1"
        },
        "fields": {
          "values": [
            {
              "name": "name"
            },
            {
              "name": "email"
            },
            {
              "name": "message"
            },
            {
              "name": "subject"
            }
          ]
        }
      },
      "id": "b52e87d9-b44b-4cea-970c-af6e7030afda",
      "name": "Send Message",
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "position": [
        2192,
        656
      ],
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        2400,
        544
      ],
      "id": "79138fe1-9d35-400d-983d-fde302472428",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "jsCode": "// Palavras-chave relacionadas ao neg√≥cio da MobiliAI\nconst relevantKeywords = [\n  'mobiliai', 'mobili', 'm√≥vel', 'm√≥veis', 'moveis',\n  'sofa', 'sof√°', 'mesa', 'cadeira', 'arm√°rio', 'armario', 'cama',\n  'decora√ß√£o', 'decoracao', 'produto', 'produtos',\n  'compra', 'comprar', 'carrinho', 'checkout', 'pedido', 'pedidos',\n  'entrega', 'frete', 'prazo', 'rastreamento', 'rastrear',\n  'loja', 'lojas', 'filial', 'filiais',\n  'pre√ßo', 'preco', 'valor', 'pagamento', 'pix', 'abacatepay',\n  'garantia', 'troca', 'devolu√ß√£o', 'devolucao',\n  'categoria', 'categorias', 'estilo', 'estilos', 'material', 'materiais',\n  'favorito', 'favoritos', 'comparar', 'compara√ß√£o', 'comparacao',\n  'visualiza√ß√£o', 'visualizacao', 'visualizar', 'ambiente', 'ambientes',\n  'funcionamento', 'hor√°rio', 'horario', 'localiza√ß√£o', 'localizacao',\n  'conta', 'perfil', 'login', 'cadastro', 'registro',\n  'site', 'aplicativo', 'app', 'plataforma'\n];\n\n// Palavras-chave que indicam perguntas fora do escopo\nconst offTopicKeywords = [\n  'guerra', 'batalha', 'hist√≥ria', 'historia', 'hist√≥rico', 'historico',\n  'pol√≠tica', 'politica', 'pol√≠tico', 'politico',\n  'geografia', 'ci√™ncia', 'ciencia', 'cient√≠fico', 'cientifico',\n  'matem√°tica', 'matematica', 'f√≠sica', 'fisica', 'qu√≠mica', 'quimica',\n  'biologia', 'literatura', 'arte', 'm√∫sica', 'musica',\n  'esporte', 'futebol', 'not√≠cia', 'noticia', 'atualidade',\n  'educa√ß√£o', 'educacao', 'escola', 'universidade', 'curso',\n  'receita', 'culin√°ria', 'culinaria', 'comida',\n  'filme', 'cinema', 's√©rie', 'serie', 'livro',\n  'celebridade', 'famoso', 'fama'\n];\n\nconst chatInput = $input.item.json.chatInput || '';\nconst inputLower = chatInput.toLowerCase();\n\n// Verifica se cont√©m palavras-chave relevantes\nconst hasRelevantKeyword = relevantKeywords.some(keyword => \n  inputLower.includes(keyword)\n);\n\n// Verifica se cont√©m palavras-chave fora do escopo\nconst hasOffTopicKeyword = offTopicKeywords.some(keyword => \n  inputLower.includes(keyword)\n);\n\n// Se tem palavra fora do escopo E n√£o tem palavra relevante, bloqueia\nif (hasOffTopicKeyword && !hasRelevantKeyword) {\n  return {\n    json: {\n      ...$input.item.json,\n      output: 'Desculpe, mas sou especializado em ajudar com quest√µes relacionadas √† MobiliAI - nossos produtos, compras, entregas e servi√ßos. üòä\\n\\nPosso te ajudar com:\\n‚Ä¢ Informa√ß√µes sobre nossos m√≥veis e produtos\\n‚Ä¢ Processo de compra e entrega\\n‚Ä¢ D√∫vidas sobre pedidos\\n‚Ä¢ Pol√≠ticas da loja\\n‚Ä¢ Qualquer outra quest√£o relacionada √† MobiliAI\\n\\nComo posso te ajudar hoje?',\n      isOutOfScope: true\n    }\n  };\n}\n\n// Passa para o AI Agent processar\nreturn {\n  json: {\n    ...$input.item.json,\n    isOutOfScope: false\n  }\n};"
      },
      "id": "74e8b1b3-4aa4-4076-9b2e-4eb82ae8212f",
      "name": "Validate Question Scope1",
      "type": "n8n-nodes-base.code",
      "position": [
        1488,
        688
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ output: $json.output }) }}",
        "options": {}
      },
      "id": "390317ab-a4b0-4a62-84fe-51e3c25a7daf",
      "name": "Respond Out of Scope1",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [
        2064,
        832
      ],
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "scope-check-condition",
              "operator": {
                "type": "boolean",
                "operation": "true"
              },
              "leftValue": "={{ $json.isOutOfScope }}",
              "rightValue": true
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "4e136dea-361b-4712-99f9-d3cddb63d6da",
      "name": "Check If Out of Scope1",
      "type": "n8n-nodes-base.if",
      "position": [
        1712,
        688
      ],
      "typeVersion": 2.2
    }
  ],
  "connections": {
    "Chat Trigger": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Window Buffer Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Validate Question Scope1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond With Initial Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Message": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Validate Question Scope1": {
      "main": [
        [
          {
            "node": "Check If Out of Scope1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check If Out of Scope1": {
      "main": [
        [
          {
            "node": "Respond Out of Scope1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "0b71e8c8686d2a5bf3befc391e55ef400b74189864d87707e143aca40b0491c1"
  }
}
